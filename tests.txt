jebance@SIGMA:~/git/nzcore$ node --test dist/test/integration.test.js
✅ All integration tests passed!
Starting test: Complete identity lifecycle
Generating identity...
Identity generated
Mnemonic validated
Public key OK
Creating document...
=== createDocument start ===
Type: test
Payload: { message: 'Hello, world!' }
Instance initialized OK
Logical time: 2
Parent hash: 0000000000000000000000000000000000000000000000000000000000000000
Document ID: d66dda30c8b872a9606436cc0bac4412b81772ad715e92bc808c1e60a11b80c4
Building document...
Document built, fields: [
  'chain_id',
  'created_at',
  'crypto_suite',
  'id',
  'logical_time',
  'parent_hash',
  'payload',
  'type',
  'version'
]
Preparing for signing...
Serializing to canonical JSON...
Canonical JSON: {"chain_id":"019c32104cf9dccae9f9ab6c3eb2e8945f167931d57bcb4ac44473f2976f8290","created_at":"2026-02...
Signing with private key...
Private key length: 32
Signature bytes length: 64
Signature bytes (first 10): 216e73b32011bf10d21d
Signature hex length: 128
Signature hex (first 20): 216e73b32011bf10d21d
=== createDocument end ===
Document created: d66dda30c8b872a9606436cc0bac4412b81772ad715e92bc808c1e60a11b80c4
Verifying document...
Verification result: {
  structural_valid: true,
  cryptographic_valid: true,
  policy_valid: true,
  final: true,
  errors: [],
  warnings: []
}
Exporting state...
State exported, length: 829
Creating new core with same mnemonic...
New core created
Importing state...
State imported
Creating document in new core...
=== createDocument start ===
Type: test
Payload: { message: 'Hello, world!' }
Instance initialized OK
Logical time: 3
Parent hash: d66dda30c8b872a9606436cc0bac4412b81772ad715e92bc808c1e60a11b80c4
Document ID: c9d9cab30144a3eaeee773df4af2cd5f23f2bd36cfb818ba9d3105738027aa5e
Building document...
Document built, fields: [
  'chain_id',
  'created_at',
  'crypto_suite',
  'id',
  'logical_time',
  'parent_hash',
  'payload',
  'type',
  'version'
]
Preparing for signing...
Serializing to canonical JSON...
Canonical JSON: {"chain_id":"019c32104cf9dccae9f9ab6c3eb2e8945f167931d57bcb4ac44473f2976f8290","created_at":"2026-02...
Signing with private key...
Private key length: 32
Signature bytes length: 64
Signature bytes (first 10): e462bdd6e60ec52cc2e
Signature hex length: 128
Signature hex (first 20): 0e462bdd6e60ec52cc2e
=== createDocument end ===
Document created in new core: c9d9cab30144a3eaeee773df4af2cd5f23f2bd36cfb818ba9d3105738027aa5e
Test completed successfully
Starting test: Deterministic identity
Core1 public key: fd272d00ea6f6991c7c908db9746b6d9ab574be98f275f2753d0dbc87cb773b5
Core2 public key: fd272d00ea6f6991c7c908db9746b6d9ab574be98f275f2753d0dbc87cb773b5
Deterministic identity test completed
Starting test: Logical time
Times: 2 3 4
Expected error caught
Logical time test completed
Starting test: Fork detection
=== createDocument start ===
Type: doc1
Payload: {}
Instance initialized OK
Logical time: 2
Parent hash: 0000000000000000000000000000000000000000000000000000000000000000
Document ID: d51019fb9298a192453b0a1881cbaa37fb75e55e0a8e95209dc3b75197c94299
Building document...
Document built, fields: [
  'chain_id',
  'created_at',
  'crypto_suite',
  'id',
  'logical_time',
  'parent_hash',
  'payload',
  'type',
  'version'
]
Preparing for signing...
Serializing to canonical JSON...
Canonical JSON: {"chain_id":"df66707322ce4e1da3beb446c68a2a78c9541b3c072e90ce443a1563b0186f97","created_at":"2026-02...
Signing with private key...
Private key length: 32
Signature bytes length: 64
Signature bytes (first 10): 59e4649bbf6365f690ab
Signature hex length: 128
Signature hex (first 20): 59e4649bbf6365f690ab
=== createDocument end ===
Document created
Forks detected: 0
Fork detection test completed
Starting test: Canonical JSON
Canonical: {"a":{"c":1,"d":2},"b":[3,2,1],"z":null}
Expected error caught
Canonical JSON test completed
Starting test: Zeroization
Zeroization test completed
Starting test: Constant-time comparison
Constant-time test completed
Starting test: Chain integrity
=== createDocument start ===
Type: doc-0
Payload: { index: 0 }
Instance initialized OK
Logical time: 2
Parent hash: 0000000000000000000000000000000000000000000000000000000000000000
Document ID: d51019fb9298a192453b0a1881cbaa37fb75e55e0a8e95209dc3b75197c94299
Building document...
Document built, fields: [
  'chain_id',
  'created_at',
  'crypto_suite',
  'id',
  'logical_time',
  'parent_hash',
  'payload',
  'type',
  'version'
]
Preparing for signing...
Serializing to canonical JSON...
Canonical JSON: {"chain_id":"df66707322ce4e1da3beb446c68a2a78c9541b3c072e90ce443a1563b0186f97","created_at":"2026-02...
Signing with private key...
Private key length: 32
Signature bytes length: 64
Signature bytes (first 10): 7a81a8ed737bc47de5f
Signature hex length: 128
Signature hex (first 20): 7a81a8ed737bc47d0e5f
=== createDocument end ===
Document 0 created: d51019fb9298a192453b0a1881cbaa37fb75e55e0a8e95209dc3b75197c94299
=== createDocument start ===
Type: doc-1
Payload: { index: 1 }
Instance initialized OK
Logical time: 3
Parent hash: d51019fb9298a192453b0a1881cbaa37fb75e55e0a8e95209dc3b75197c94299
Document ID: 35fcbd61f81145405af2de4e978a260b0792eec4a3aef97e6e9a7a9b090f6f8b
Building document...
Document built, fields: [
  'chain_id',
  'created_at',
  'crypto_suite',
  'id',
  'logical_time',
  'parent_hash',
  'payload',
  'type',
  'version'
]
Preparing for signing...
Serializing to canonical JSON...
Canonical JSON: {"chain_id":"df66707322ce4e1da3beb446c68a2a78c9541b3c072e90ce443a1563b0186f97","created_at":"2026-02...
Signing with private key...
Private key length: 32
Signature bytes length: 64
Signature bytes (first 10): 3cd2ce798418492aab9c
Signature hex length: 128
Signature hex (first 20): 3cd2ce798418492aab9c
=== createDocument end ===
Document 1 created: 35fcbd61f81145405af2de4e978a260b0792eec4a3aef97e6e9a7a9b090f6f8b
=== createDocument start ===
Type: doc-2
Payload: { index: 2 }
Instance initialized OK
Logical time: 4
Parent hash: 35fcbd61f81145405af2de4e978a260b0792eec4a3aef97e6e9a7a9b090f6f8b
Document ID: 0b71aeeb955d050115177d417008b224c65d77156fbb9e08b9631dd56dab4fab
Building document...
Document built, fields: [
  'chain_id',
  'created_at',
  'crypto_suite',
  'id',
  'logical_time',
  'parent_hash',
  'payload',
  'type',
  'version'
]
Preparing for signing...
Serializing to canonical JSON...
Canonical JSON: {"chain_id":"df66707322ce4e1da3beb446c68a2a78c9541b3c072e90ce443a1563b0186f97","created_at":"2026-02...
Signing with private key...
Private key length: 32
Signature bytes length: 64
Signature bytes (first 10): 66296016e428b2222c5c
Signature hex length: 128
Signature hex (first 20): 66296016e428b2222c5c
=== createDocument end ===
Document 2 created: 0b71aeeb955d050115177d417008b224c65d77156fbb9e08b9631dd56dab4fab
=== createDocument start ===
Type: doc-3
Payload: { index: 3 }
Instance initialized OK
Logical time: 5
Parent hash: 0b71aeeb955d050115177d417008b224c65d77156fbb9e08b9631dd56dab4fab
Document ID: 931e36d8b9f0962989b09338a0ed4183e961c2cf79d63d161a13996546e70e85
Building document...
Document built, fields: [
  'chain_id',
  'created_at',
  'crypto_suite',
  'id',
  'logical_time',
  'parent_hash',
  'payload',
  'type',
  'version'
]
Preparing for signing...
Serializing to canonical JSON...
Canonical JSON: {"chain_id":"df66707322ce4e1da3beb446c68a2a78c9541b3c072e90ce443a1563b0186f97","created_at":"2026-02...
Signing with private key...
Private key length: 32
Signature bytes length: 64
Signature bytes (first 10): 91e89c56c8cd5c5fef
Signature hex length: 128
Signature hex (first 20): 91e89c560c8cd5c50fef
=== createDocument end ===
Document 3 created: 931e36d8b9f0962989b09338a0ed4183e961c2cf79d63d161a13996546e70e85
=== createDocument start ===
Type: doc-4
Payload: { index: 4 }
Instance initialized OK
Logical time: 6
Parent hash: 931e36d8b9f0962989b09338a0ed4183e961c2cf79d63d161a13996546e70e85
Document ID: 0adfb9aa698578f454a752823033bac51929e5274fc491d092bfb719a7803896
Building document...
Document built, fields: [
  'chain_id',
  'created_at',
  'crypto_suite',
  'id',
  'logical_time',
  'parent_hash',
  'payload',
  'type',
  'version'
]
Preparing for signing...
Serializing to canonical JSON...
Canonical JSON: {"chain_id":"df66707322ce4e1da3beb446c68a2a78c9541b3c072e90ce443a1563b0186f97","created_at":"2026-02...
Signing with private key...
Private key length: 32
Signature bytes length: 64
Signature bytes (first 10): 70dcdb58b4c8f5c2ed4
Signature hex length: 128
Signature hex (first 20): 70dcdb58b4c8f5c20ed4
=== createDocument end ===
Document 4 created: 0adfb9aa698578f454a752823033bac51929e5274fc491d092bfb719a7803896
Chain state: {
  chainId: 'df66707322ce4e1da3beb446c68a2a78c9541b3c072e90ce443a1563b0186f97',
  lastHash: '0adfb9aa698578f454a752823033bac51929e5274fc491d092bfb719a7803896',
  logicalClock: 6,
  documentCount: 5,
  forks: []
}
Chain integrity test completed
Starting test: Invalid mnemonic
Error caught: NewZoneCoreError: Invalid BIP-39 mnemonic
    at new NewZoneCore (file:///home/jebance/git/nzcore/dist/src/core.js:40:19)
    at NewZoneCore.create (file:///home/jebance/git/nzcore/dist/src/core.js:49:26)
    at TestContext.<anonymous> (file:///home/jebance/git/nzcore/dist/test/integration.test.js:149:35)
    at Test.runInAsyncScope (node:async_hooks:214:14)
    at Test.run (node:internal/test_runner/test:1047:25)
    at Test.start (node:internal/test_runner/test:944:17)
    at TestContext.test (node:internal/test_runner/test:373:20)
    at TestContext.<anonymous> (file:///home/jebance/git/nzcore/dist/test/integration.test.js:146:17)
    at async Test.run (node:internal/test_runner/test:1054:7)
    at async startSubtestAfterBootstrap (node:internal/test_runner/harness:297:3) {
  code: 'ERR_INVALID_MNEMONIC',
  context: undefined
}
Invalid mnemonic test completed
Starting test: Memory cleanup
=== createDocument start ===
Type: test
Payload: {}
Instance initialized OK
Logical time: 2
Parent hash: 0000000000000000000000000000000000000000000000000000000000000000
Document ID: d51019fb9298a192453b0a1881cbaa37fb75e55e0a8e95209dc3b75197c94299
Building document...
Document built, fields: [
  'chain_id',
  'created_at',
  'crypto_suite',
  'id',
  'logical_time',
  'parent_hash',
  'payload',
  'type',
  'version'
]
Preparing for signing...
Serializing to canonical JSON...
Canonical JSON: {"chain_id":"df66707322ce4e1da3beb446c68a2a78c9541b3c072e90ce443a1563b0186f97","created_at":"2026-02...
Signing with private key...
Private key length: 32
Signature bytes length: 64
Signature bytes (first 10): 235126fc862b9987c6e
Signature hex length: 128
Signature hex (first 20): 235126fc0862b9987c6e
=== createDocument end ===
Core destroyed
=== createDocument start ===
Type: test
Payload: {}
Error caught after destroy: Error: NewZoneCore instance not properly initialized
    at NewZoneCore.assertInitialized (file:///home/jebance/git/nzcore/dist/src/core.js:214:19)
    at NewZoneCore.createDocument (file:///home/jebance/git/nzcore/dist/src/core.js:82:14)
    at TestContext.<anonymous> (file:///home/jebance/git/nzcore/dist/test/integration.test.js:166:28)
    at async Test.run (node:internal/test_runner/test:1054:7)
    at async TestContext.<anonymous> (file:///home/jebance/git/nzcore/dist/test/integration.test.js:159:9)
    at async Test.run (node:internal/test_runner/test:1054:7)
    at async startSubtestAfterBootstrap (node:internal/test_runner/harness:297:3)
Memory cleanup test completed
▶ NewZoneCore - Full Integration
  ✔ Complete identity lifecycle (710.707857ms)
  ✔ Deterministic identity from same mnemonic (500.743044ms)
  ✔ Logical time monotonic invariant (1.896741ms)
  ✔ Fork detection - no auto resolution (265.965209ms)
  ✔ Canonical JSON enforcement (2.861651ms)
  ✔ Secure zeroization (0.886807ms)
  ✔ Constant-time comparison (0.647377ms)
  ✔ Chain integrity verification (291.401835ms)
  ✔ Error handling - invalid mnemonic (6.844829ms)
  ✔ Memory cleanup (259.527588ms)
✔ NewZoneCore - Full Integration (2049.988574ms)
ℹ tests 11
ℹ suites 0
ℹ pass 11
ℹ fail 0
ℹ cancelled 0
ℹ skipped 0
ℹ todo 0
ℹ duration_ms 2276.034612
jebance@SIGMA:~/git/nzcore$ 

